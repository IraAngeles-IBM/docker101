
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Reconciliation Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../troubleshooting/troubleshooting.html" />
    
    
    <link rel="prev" href="step4.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">docker101 lab</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../lab0/lab0.html">
            
                <a href="../lab0/lab0.html">
            
                    
                    Lab 0: Install Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../lab1/lab1.html">
            
                <a href="../lab1/lab1.html">
            
                    
                    Lab 1: Run your first container
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../lab1/step1.html">
            
                <a href="../lab1/step1.html">
            
                    
                    Run your first container
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../lab1/step2.html">
            
                <a href="../lab1/step2.html">
            
                    
                    Run Multiple Containers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../lab1/step3.html">
            
                <a href="../lab1/step3.html">
            
                    
                    Clean Up
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../lab2/lab2.html">
            
                <a href="../lab2/lab2.html">
            
                    
                    Lab 2: Adding Value with Custom Docker Images
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../lab2/step1.html">
            
                <a href="../lab2/step1.html">
            
                    
                    Login to Docker Hub and Create a python app
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../lab2/step2.html">
            
                <a href="../lab2/step2.html">
            
                    
                    Create and build the Docker Image
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../lab2/step3.html">
            
                <a href="../lab2/step3.html">
            
                    
                    Run the Docker image and Push to a central registry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../lab2/step4.html">
            
                <a href="../lab2/step4.html">
            
                    
                    Deploying a Change
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="lab3.html">
            
                <a href="lab3.html">
            
                    
                    Lab 3: Introduction to Orchestration
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="step1.html">
            
                <a href="step1.html">
            
                    
                    Create your first swarm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="step2.html">
            
                <a href="step2.html">
            
                    
                    Deploy your first service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="step3.html">
            
                <a href="step3.html">
            
                    
                    Scale your service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="step4.html">
            
                <a href="step4.html">
            
                    
                    Rolling Updates
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.5" data-path="step5.html">
            
                <a href="step5.html">
            
                    
                    Reconciliation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../troubleshooting/troubleshooting.html">
            
                <a href="../troubleshooting/troubleshooting.html">
            
                    
                    Troubleshooting
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Other Resources</li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <a target="_blank" href="https://cognitiveclass.ai/courses/docker-essentials">
            
                    
                    Badge: Docker Essentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" >
            
                <a target="_blank" href="https://cognitiveclass.ai/courses/kubernetes-course">
            
                    
                    Badge: Container & Kubernetes Essentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" >
            
                <a target="_blank" href="https://developer.ibm.com/gettingstarted/containers/">
            
                    
                    Get started with containers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" >
            
                <a target="_blank" href="https://docs.docker.com/">
            
                    
                    Docker Documentation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" >
            
                <a target="_blank" href="https://www.youtube.com/watch?v=JSLpG_spOBM">
            
                    
                    What is Containers and Dockers?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" >
            
                <a target="_blank" href="https://developer.ibm.com/">
            
                    
                    developer.ibm.com
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">IBM Developer</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../team.html">
            
                <a href="../team.html">
            
                    
                    IBM Developer ASEAN Team
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Reconciliation</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="lab-3---introduction-to-orchestration">Lab 3 - Introduction to Orchestration</h1>
<h2 id="step-5-reconciliation">Step 5: Reconciliation</h2>
<p>In the previous step, we updated the state of our service using <code>docker service update</code>. We saw Docker Swarm in action as it recognized the mismatch between desired state and actual state, and attempted to solve this issue.</p>
<p>The &quot;inspect-&gt;adapt&quot; model of docker swarm enables it to perform reconciliation when something goes wrong. For example, when a node in the swarm goes down it might take down running containers with it. The swarm will recognize this loss of containers, and will attempt to reschedule containers on available nodes in order to achieve the desired state for that service.</p>
<p>We are going to remove a node, and see tasks of our nginx1 service be rescheduled on other nodes automatically.</p>
<ol>
<li><p>For the sake of clean output, first create a brand new service by copying the line below. We will change the name, and the publish port to avoid conflicts with our existing service. We will also add the <code>--replicas</code> command to scale the service with 5 instances.</p>
<pre><code class="lang-sh"> $ docker service create --detach=<span class="hljs-literal">true</span> --name nginx2 --replicas=5 --publish 81:80  --mount <span class="hljs-built_in">source</span>=/etc/hostname,target=/usr/share/nginx/html/index.html,<span class="hljs-built_in">type</span>=<span class="hljs-built_in">bind</span>,ro nginx:1.12
 aiqdh5n9fyacgvb2g82s412js
</code></pre>
</li>
<li><p>On Node1, use <code>watch</code> to watch the update from the output of <code>docker service ps</code>. Note &quot;watch&quot; is a linux utility and might not be available on other platforms.</p>
<pre><code class="lang-sh"> $ watch -n 1 docker service ps nginx2
 ok
</code></pre>
<p> This should result in a window that looks like this:</p>
<pre><code class="lang-sh"> Every 1s: docker service ps nginx1 2                                                                                              2017-05-12 15:29:20

 ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STAT
 E            ERROR               PORTS
 6koehbhsfbi7         nginx2.1        nginx:1.12          node3               Running            Running 21 s
 econds ago
 dou2brjfr6lt        nginx2.2            nginx:1.12          node1               Running             Running 26 s
 econds ago
 8jc41tgwowph        nginx2.3            nginx:1.12          node2               Running             Running 27 s
 econds ago
 n5n8zryzg6g6        nginx2.4            nginx:1.12          node1               Running             Running 26 s
 econds ago
 cnofhk1v5bd8        nginx2.5            nginx:1.12          node2               Running             Running 27 s
 econds ago
 [node1] (loc
</code></pre>
</li>
<li><p>Click on Node3, and type the command to leave the swarm cluster.</p>
<pre><code class="lang-sh"> $ docker swarm leave
 ok
</code></pre>
<p> This is the &quot;nice&quot; way to leave the swarm, but you can also kill the node and the following behavior will be the same.</p>
</li>
<li><p>Click on Node1 to watch the reconciliation in action. You should see that the swarm will attempt to get back to the declared state by rescheduling the containers that were running on node3 to node1 and node2 automatically.</p>
<pre><code class="lang-sh"> $ docker service ps nginx2
 ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS
 jeq4604k1v9k        nginx2.1            nginx:1.12          node1               Running             Running 5 seconds ago
 6koehbhsfbi7         \_ nginx2.1        nginx:1.12          node3               Shutdown            Running 21 seconds ago
 dou2brjfr6lt        nginx2.2            nginx:1.12          node1               Running             Running 26 seconds ago
 8jc41tgwowph        nginx2.3            nginx:1.12          node2               Running             Running 27 seconds ago
 n5n8zryzg6g6        nginx2.4            nginx:1.12          node1               Running             Running 26 seconds ago
 cnofhk1v5bd8        nginx2.5            nginx:1.12          node2               Running             Running 27 seconds ago
 [node1] (loc
</code></pre>
</li>
</ol>
<h2 id="number-of-nodes">Number of nodes</h2>
<p>In this lab, our Docker Swarm cluster consists of one master, and two worker nodes. This configuration is not highly available. The manager node contains the necessary information to manage the cluster, so if this node goes down, the cluster will cease to function. For a production application, you will want to provision a cluster with multiple manager nodes to allow for manager node failures.</p>
<p>For manager nodes you want at least 3, but typically no more than 7. Managers implement the raft consensus algorithm, which requires that more than 50% of the nodes agree on the state that is being stored for the cluster. If you don&apos;t achieve &gt;50%, the swarm will cease to operate correctly. For this reason, the following can be assumed about node failure tolerance.</p>
<ul>
<li>3 manager nodes tolerates 1 node failure</li>
<li>5 manager nodes tolerates 2 node failures</li>
<li>7 manager nodes tolerates 3 node failures</li>
</ul>
<p>It is possible to have an even number of manager nodes, but it adds no value in terms of the number of node failures. For example, 4 manager nodes would only tolerate 1 node failure, which is the same tolerance as a 3 manager node cluster. The more manager nodes you have, the harder it is to achieve a consensus on the state of a cluster.</p>
<p>While you typically want to limit the number of manager nodes to no more than 7, you can scale the number of worker nodes much higher than that. Worker nodes can scale up into the 1000&apos;s of nodes. Worker nodes communicate using the gossip protocol, which is optimized to be highly performant under large traffic and a large number of nodes.</p>
<p>If you are using <a href="http://play-with-docker.com" target="_blank">Play with Docker</a>, you can easily deploy multiple manager node clusters using the built in templates. Click the templates icon in the upper left to see what templates are available.</p>
<h2 id="summary">Summary</h2>
<p>In this lab, you got an introduction to problems that come with running container with production such as scheduling services across distributed nodes, maintaining high availability, implementing reconciliation, scaling, and logging. We used the orchestration tool that comes built-in to the Docker Engine- Docker Swarm, to address some of these issues.</p>
<p>Key Takeaways:</p>
<ul>
<li>The Docker Swarm schedules services using a declarative language. You declare the state, and the swarm attempts to maintain and reconcile to make sure the actual state == desired state</li>
<li>Docker Swarm is composed of manager and worker nodes. Only managers can maintain the state of the swarm and accept commands to modify it. Workers have high scability and are only  used to run containers. By default managers can run containers as well.</li>
<li>The routing mesh built into swarm means that any port that is published at the service level will be exposed on every node in the swarm. Requests to a published service port will be routed automatically to a container of the service that is running in the swarm.</li>
<li>Many tools out there exist to help solve problems with orchestration containerized applications in production, include Docker Swarm, and the <a href="https://cloud.ibm.com/kubernetes/catalog/create" target="_blank">IBM Kubernetes Service</a>.</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="step4.html" class="navigation navigation-prev " aria-label="Previous page: Rolling Updates">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../troubleshooting/troubleshooting.html" class="navigation navigation-next " aria-label="Next page: Troubleshooting">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Reconciliation","level":"1.5.5","depth":2,"next":{"title":"Troubleshooting","level":"1.6","depth":1,"path":"troubleshooting/troubleshooting.md","ref":"troubleshooting/troubleshooting.md","articles":[]},"previous":{"title":"Rolling Updates","level":"1.5.4","depth":2,"path":"lab3/step4.md","ref":"lab3/step4.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["custom-favicon"],"pluginsConfig":{"favicon":"/images/favicon.ico","custom-favicon":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"lab3/step5.md","mtime":"2020-08-03T07:39:55.738Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-08-11T10:16:52.645Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

