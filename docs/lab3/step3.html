
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Scale your service Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="step4.html" />
    
    
    <link rel="prev" href="step2.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">docker101 lab</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../lab0/lab0.html">
            
                <a href="../lab0/lab0.html">
            
                    
                    Lab 0: Install Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../lab1/lab1.html">
            
                <a href="../lab1/lab1.html">
            
                    
                    Lab 1: Run your first container
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../lab1/step1.html">
            
                <a href="../lab1/step1.html">
            
                    
                    Run your first container
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../lab1/step2.html">
            
                <a href="../lab1/step2.html">
            
                    
                    Run Multiple Containers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../lab1/step3.html">
            
                <a href="../lab1/step3.html">
            
                    
                    Clean Up
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../lab2/lab2.html">
            
                <a href="../lab2/lab2.html">
            
                    
                    Lab 2: Adding Value with Custom Docker Images
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../lab2/step1.html">
            
                <a href="../lab2/step1.html">
            
                    
                    Login to Docker Hub and Create a python app
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../lab2/step2.html">
            
                <a href="../lab2/step2.html">
            
                    
                    Create and build the Docker Image
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../lab2/step3.html">
            
                <a href="../lab2/step3.html">
            
                    
                    Run the Docker image and Push to a central registry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../lab2/step4.html">
            
                <a href="../lab2/step4.html">
            
                    
                    Deploying a Change
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="lab3.html">
            
                <a href="lab3.html">
            
                    
                    Lab 3: Introduction to Orchestration
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="step1.html">
            
                <a href="step1.html">
            
                    
                    Create your first swarm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="step2.html">
            
                <a href="step2.html">
            
                    
                    Deploy your first service
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.3" data-path="step3.html">
            
                <a href="step3.html">
            
                    
                    Scale your service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="step4.html">
            
                <a href="step4.html">
            
                    
                    Rolling Updates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="step5.html">
            
                <a href="step5.html">
            
                    
                    Reconciliation
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../troubleshooting/troubleshooting.html">
            
                <a href="../troubleshooting/troubleshooting.html">
            
                    
                    Troubleshooting
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Other Resources</li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <a target="_blank" href="https://cognitiveclass.ai/learn/containers-k8s-and-istio-on-ibm-cloud">
            
                    
                    Container & Kubernetes Essentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" >
            
                <a target="_blank" href="https://developer.ibm.com/gettingstarted/containers/">
            
                    
                    Get started with containers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" >
            
                <a target="_blank" href="https://docs.docker.com/">
            
                    
                    Docker Documentation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" >
            
                <a target="_blank" href="https://www.youtube.com/watch?v=JSLpG_spOBM">
            
                    
                    What is Containers and Dockers?
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">IBM Developer</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../team.html">
            
                <a href="../team.html">
            
                    
                    IBM Developer ASEAN Team
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Scale your service</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="lab-3--introduction-to-orchestration">Lab 3- Introduction to Orchestration</h1>
<h2 id="step-3-scale-your-service">Step 3: Scale your service</h2>
<p>In production we may need to handle large amounts of traffic to our application. So let&apos;s scale!</p>
<ol>
<li><p>Update your service with an updated number of replicas</p>
<p> We are going to use the <code>docker service</code> command to update the nginx service we created earlier to include 5 replicas. This is defining a new state for our service.</p>
<pre><code class="lang-sh"> $ docker service update --replicas=5 --detach=<span class="hljs-literal">true</span> nginx1
 nginx1
</code></pre>
<p> As soon as this command is run the following happens:</p>
<ol>
<li>The state of the service is updated to 5 replicas (which is stored in the swarms internal storage).</li>
<li>Docker swarm recognizes that the number of replicas that is scheduled now does not match the declared state of 5.</li>
<li><p>Docker swarm schedules 5 more tasks (containers) in an attempt to meet the declared state for the service.</p>
<p>This swarm is actively checking to see if the desired state is equal to actual state, and will attempt to reconcile if needed.</p>
</li>
</ol>
</li>
<li><p>Check the running instances</p>
<p> After a few seconds, you should see that the swarm did its job, and successfully started 9 more containers. Notice that the containers are scheduled across all three nodes of the cluster. The default placement strategy that is used to decide where new containers are to be run is &quot;emptiest node&quot;, but that can be changed based on your need.</p>
<pre><code class="lang-sh"> $ docker service ps nginx1
 ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STAT
 E            ERROR               PORTS
 iu3ksewv7qf9        nginx1.1            nginx:1.12          node1               Running             Running 17 m
 inutes ago
 lfz1bhl6v77r        nginx1.2            nginx:1.12          node2               Running             Running 6 mi
 nutes ago
 qururb043dwh        nginx1.3            nginx:1.12          node3               Running             Running 6 mi
 nutes ago
 q53jgeeq7y1x        nginx1.4            nginx:1.12          node3               Running             Running 6 mi
 nutes ago
 xj271k2829uz        nginx1.5            nginx:1.12          node1               Running             Running 7 mi
 nutes ago
</code></pre>
</li>
<li><p>Send a bunch of requests to <a href="http://localhost:80" target="_blank">localhost:80</a></p>
<p> The <code>--publish 80:80</code> is still in effect for this service, that was not changed when we ran <code>docker service update</code>. However, now when we send requests on port 80, the routing mesh has multiple containers in which to route requests to. The routing mesh acts as a load balancer for these containers, alternating where it routes requests to.</p>
<p> Let&apos;s try it out by curling multiple times. Note, that it doesn&apos;t matter which node you send the requests. There is no connection between the node that receives the request, and the node that that request is routed to.</p>
<pre><code class="lang-sh"> $ curl localhost:80
 node3
 $ curl localhost:80
 node3
 $ curl localhost:80
 node2
 $ curl localhost:80
 node1
 $ curl localhost:80
 node1
</code></pre>
</li>
</ol>
<p>You should see which node is serving each request because of the nifty <code>--mount</code> command we used earlier.</p>
<p><strong>Limits of the routing Mesh</strong>
The routing mesh can only publish one service on port 80. If you want multiple services exposed on port 80, then you can use an external application load balancer outside of the swarm to accomplish this.</p>
<ol>
<li><p>Check the aggregated logs for the service</p>
<p> Another easy way to see which nodes those requests were routed to is to check the aggregated logs. We can get aggregated logs for the service using <code>docker service logs [service name]</code>. This aggregates the output from every running container, i.e. the output from <code>docker container logs [container name]</code>.</p>
<pre><code class="lang-sh"> $ docker service logs nginx1
 nginx1.4.q53jgeeq7y1x@node3    | 10.255.0.2 - - [28/Jun/2017:18:59:39 +0000] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 6 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.
 52.1&quot;</span> <span class="hljs-string">&quot;-&quot;</span>
 nginx1.2.lfz1bhl6v77r@node2    | 10.255.0.2 - - [28/Jun/2017:18:59:40 +0000] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 6 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.
 52.1&quot;</span> <span class="hljs-string">&quot;-&quot;</span>
 nginx1.5.xj271k2829uz@node1    | 10.255.0.2 - - [28/Jun/2017:18:59:41 +0000] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 6 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.
 52.1&quot;</span> <span class="hljs-string">&quot;-&quot;</span>
 nginx1.1.iu3ksewv7qf9@node1    | 10.255.0.2 - - [28/Jun/2017:18:50:23 +0000] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 6 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.
 52.1&quot;</span> <span class="hljs-string">&quot;-&quot;</span>
 nginx1.1.iu3ksewv7qf9@node1    | 10.255.0.2 - - [28/Jun/2017:18:59:41 +0000] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 6 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.
 52.1&quot;</span> <span class="hljs-string">&quot;-&quot;</span>
 nginx1.3.qururb043dwh@node3    | 10.255.0.2 - - [28/Jun/2017:18:59:38 +0000] <span class="hljs-string">&quot;GET / HTTP/1.1&quot;</span> 200 6 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.
 52.1&quot;</span> <span class="hljs-string">&quot;-&quot;</span>
</code></pre>
<p> Based on these logs we can see that each request was served by a different container.</p>
<p> In addition to seeing whether the request was sent to node1, node2, or node3, you can also see which container on each node that it was sent to. For example <code>nginx1.5</code> means that request was sent to container with that same name as indicated in the output of <code>docker service ps nginx1</code>.</p>
</li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="step2.html" class="navigation navigation-prev " aria-label="Previous page: Deploy your first service">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="step4.html" class="navigation navigation-next " aria-label="Next page: Rolling Updates">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Scale your service","level":"1.5.3","depth":2,"next":{"title":"Rolling Updates","level":"1.5.4","depth":2,"path":"lab3/step4.md","ref":"lab3/step4.md","articles":[]},"previous":{"title":"Deploy your first service","level":"1.5.2","depth":2,"path":"lab3/step2.md","ref":"lab3/step2.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["custom-favicon"],"pluginsConfig":{"favicon":"/images/favicon.ico","custom-favicon":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"lab3/step3.md","mtime":"2020-08-03T06:41:24.972Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-08-03T07:26:38.867Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

